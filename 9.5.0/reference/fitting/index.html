
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mustang-sz.github.io/WITCH/9.5.0/reference/fitting/">
      
      
        <link rel="prev" href="../fitter/">
      
      
        <link rel="next" href="../forward_modeling/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>fitting - WITCH</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#witch.fitting" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="WITCH" class="md-header__button md-logo" aria-label="WITCH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WITCH
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              fitting
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="WITCH" class="md-nav__button md-logo" aria-label="WITCH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    WITCH
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../containers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    containers
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../dataset/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    dataset
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    external
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            external
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_1" >
        
          
          <label class="md-nav__link" for="__nav_3_4_1" id="__nav_3_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    act_map
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_1">
            <span class="md-nav__icon md-icon"></span>
            act_map
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external/act_map/funcs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    funcs
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    minkasi
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            minkasi
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external/minkasi/funcs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    funcs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external/minkasi/mapmaking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    mapmaking
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../external/minkasi/utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fitter/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    fitter
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    fitting
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    fitting
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#witch.fitting" class="md-nav__link">
    <span class="md-ellipsis">
      fitting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.fit_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      fit_dataset
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.hmc" class="md-nav__link">
    <span class="md-ellipsis">
      hmc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.invsafe" class="md-nav__link">
    <span class="md-ellipsis">
      invsafe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.invscale" class="md-nav__link">
    <span class="md-ellipsis">
      invscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.run_mcmc" class="md-nav__link">
    <span class="md-ellipsis">
      run_mcmc
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../forward_modeling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    forward_modeling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../grid/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    grid
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../nonparametric/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    nonparametric
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../objective/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    objective
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    plotting
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../structure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    structure
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    utils
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#witch.fitting" class="md-nav__link">
    <span class="md-ellipsis">
      fitting
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.fit_dataset" class="md-nav__link">
    <span class="md-ellipsis">
      fit_dataset
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.hmc" class="md-nav__link">
    <span class="md-ellipsis">
      hmc
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.invsafe" class="md-nav__link">
    <span class="md-ellipsis">
      invsafe
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.invscale" class="md-nav__link">
    <span class="md-ellipsis">
      invscale
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.fitting.run_mcmc" class="md-nav__link">
    <span class="md-ellipsis">
      run_mcmc
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



  <h1>fitting</h1>

<div class="doc doc-object doc-module">



<a id="witch.fitting"></a>
    <div class="doc doc-contents first">









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="witch.fitting.fit_dataset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_dataset</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">chitol</span><span class="o">=</span><span class="mf">1e-05</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Fit a model to TODs.
This uses a modified Levenberg–Marquardt fitter with flat priors.
This function is MPI aware.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Model


  
      dataclass
   (witch.containers.Model)" href="../containers/#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model object that defines the model and grid we are fitting with.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DataSet


  
      dataclass
   (witch.dataset.DataSet)" href="../dataset/#witch.dataset.DataSet">DataSet</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to fit.
The <code>dataset.datavec.comm</code> object is used to fit in an MPI aware way.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>maxiter</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The maximum number of iterations to fit.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>chitol</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The delta chisq to use as the convergence criteria.</p>
              </div>
            </td>
            <td>
                  <code>1e-5</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Model


  
      dataclass
   (witch.containers.Model)" href="../containers/#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Model with the final set of fit parameters, errors, and chisq.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>final_iter</code></td>            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of iterations the fitter ran for.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>delta_chisq</code></td>            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The final delta chisq.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>witch/fitting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">jit</span><span class="p">,</span> <span class="n">static_argnums</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fit_dataset</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">DataSet</span><span class="p">,</span>
    <span class="n">maxiter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">chitol</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Model</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fit a model to TODs.</span>
<span class="sd">    This uses a modified Levenberg–Marquardt fitter with flat priors.</span>
<span class="sd">    This function is MPI aware.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Model</span>
<span class="sd">        The model object that defines the model and grid we are fitting with.</span>
<span class="sd">    dataset : DataSet</span>
<span class="sd">        The dataset to fit.</span>
<span class="sd">        The `dataset.datavec.comm` object is used to fit in an MPI aware way.</span>
<span class="sd">    maxiter : int, default: 10</span>
<span class="sd">        The maximum number of iterations to fit.</span>
<span class="sd">    chitol : float, default: 1e-5</span>
<span class="sd">        The delta chisq to use as the convergence criteria.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : Model</span>
<span class="sd">        Model with the final set of fit parameters, errors, and chisq.</span>
<span class="sd">    final_iter : int</span>
<span class="sd">        The number of iterations the fitter ran for.</span>
<span class="sd">    delta_chisq : float</span>
<span class="sd">        The final delta chisq.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;tod&quot;</span><span class="p">,</span> <span class="s2">&quot;map&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid mode&quot;</span><span class="p">)</span>
    <span class="n">zero</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_cond_func</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">delta_chisq</span><span class="p">,</span> <span class="n">lmd</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">iterbool</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">lt</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">maxiter</span><span class="p">)</span>
        <span class="n">chisqbool</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="n">delta_chisq</span><span class="p">,</span> <span class="n">chitol</span><span class="p">)</span> <span class="o">+</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">gt</span><span class="p">(</span><span class="n">lmd</span><span class="p">,</span> <span class="n">zero</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">iterbool</span> <span class="o">*</span> <span class="n">chisqbool</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_body_func</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
        <span class="n">i</span><span class="p">,</span> <span class="n">delta_chisq</span><span class="p">,</span> <span class="n">lmd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">val</span>
        <span class="n">curve_use</span> <span class="o">=</span> <span class="n">curve</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">lmd</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">curve</span><span class="p">)))</span>
        <span class="c1"># Get the step</span>
        <span class="n">step</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">),</span> <span class="n">grad</span><span class="p">)</span>
        <span class="n">new_pars</span><span class="p">,</span> <span class="n">to_fit</span> <span class="o">=</span> <span class="n">_prior_pars_fit</span><span class="p">(</span>
            <span class="n">model</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pars</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Get errs</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">to_fit</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">invscale</span><span class="p">(</span><span class="n">curve_use</span><span class="p">))),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># Now lets get an updated model</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_pars</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">errs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
        <span class="n">new_chisq</span><span class="p">,</span> <span class="n">new_grad</span><span class="p">,</span> <span class="n">new_curve</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span>
            <span class="n">new_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="p">)</span>
        <span class="n">new_model</span> <span class="o">=</span> <span class="n">new_model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">new_pars</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">new_chisq</span><span class="p">)</span>

        <span class="n">new_delta_chisq</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span> <span class="o">-</span> <span class="n">new_model</span><span class="o">.</span><span class="n">chisq</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">delta_chisq</span><span class="p">,</span> <span class="n">lmd</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">new_delta_chisq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
            <span class="n">_success</span><span class="p">,</span>
            <span class="n">_failure</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">new_model</span><span class="p">,</span>
            <span class="n">grad</span><span class="p">,</span>
            <span class="n">new_grad</span><span class="p">,</span>
            <span class="n">curve</span><span class="p">,</span>
            <span class="n">new_curve</span><span class="p">,</span>
            <span class="n">delta_chisq</span><span class="p">,</span>
            <span class="n">new_delta_chisq</span><span class="p">,</span>
            <span class="n">lmd</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">delta_chisq</span><span class="p">,</span> <span class="n">lmd</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">grad</span><span class="p">)</span>

    <span class="n">pars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_prior_pars_fit</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit</span><span class="p">))</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">errs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
    <span class="n">chisq</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">curve</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">errs</span><span class="p">,</span> <span class="n">chisq</span><span class="p">)</span>
    <span class="n">i</span><span class="p">,</span> <span class="n">delta_chisq</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span>
        <span class="n">_cond_func</span><span class="p">,</span> <span class="n">_body_func</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">zero</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">curve</span><span class="p">,</span> <span class="n">grad</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">delta_chisq</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="witch.fitting.hmc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">hmc</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">log_prob</span><span class="p">,</span> <span class="n">log_prob_grad</span><span class="p">,</span> <span class="n">num_steps</span><span class="p">,</span> <span class="n">num_leaps</span><span class="p">,</span> <span class="n">step_size</span><span class="p">,</span> <span class="n">comm</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Runs Hamilonian Monte Carlo using a leapfrog integrator to approximate Hamilonian dynamics.
This is a naive implementaion that will be replaced in the future.</p>
<p>The parallelism model employed here is different that most samplers where each task runs
a subset of the chain, instead since the rest of WITCH employs a model where the data is
distributed across tasks we do that here as well.
In this model the chain evolves simultaneously in all tasks,
but only rank 0 actually stores the chain.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>params</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The initial parameters to start the chain at.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_prob</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="jax.Array">Array</span>], <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that returns the log probability of the model
for a given set of params. This should take <code>params</code> as its
first arguments, all other arguments should be fixed ahead of time
(ie: using <code>functools.partial</code>).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>log_prob_grad</code>
            </td>
            <td>
                  <code><span title="typing.Callable">Callable</span>[[<span title="jax.Array">Array</span>], <span title="jax.Array">Array</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Function that returns the gradient log probability of the model
for a given set of params. This should take <code>params</code> as its
first arguments, all other arguments should be fixed ahead of time
(ie: using <code>functools.partial</code>). The returned gradient should have
shape <code>(len(params),)</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_steps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of steps to run the chain for.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_leaps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of leapfrog steps to run at each step of the chain.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The step size to use.
At each leapfrog step the parameters will evolve by <code>step_size</code>*<code>momentum</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>comm</code>
            </td>
            <td>
                  <code><span title="mpi4py.MPI.Intracomm">Intracomm</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The MPI comm object to use.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>chain</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chain of samples.
Will have shape <code>(num_steps, len(params))</code> in the rank 0 task.
Note that on tasks with rank other than 0 the actual
chain is not returned, instead a dummy array of size <code>(0,)</code> is
returned.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>witch/fitting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">hmc</span><span class="p">(</span>
    <span class="n">params</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
    <span class="n">log_prob</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span>
    <span class="n">log_prob_grad</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">],</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">num_leaps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">comm</span><span class="p">:</span> <span class="n">MPI</span><span class="o">.</span><span class="n">Intracomm</span><span class="p">,</span>
    <span class="n">key</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Runs Hamilonian Monte Carlo using a leapfrog integrator to approximate Hamilonian dynamics.</span>
<span class="sd">    This is a naive implementaion that will be replaced in the future.</span>

<span class="sd">    The parallelism model employed here is different that most samplers where each task runs</span>
<span class="sd">    a subset of the chain, instead since the rest of WITCH employs a model where the data is</span>
<span class="sd">    distributed across tasks we do that here as well.</span>
<span class="sd">    In this model the chain evolves simultaneously in all tasks,</span>
<span class="sd">    but only rank 0 actually stores the chain.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : jax.Array</span>
<span class="sd">        The initial parameters to start the chain at.</span>
<span class="sd">    log_prob : Callable[[jax.Array], jax.Array]</span>
<span class="sd">        Function that returns the log probability of the model</span>
<span class="sd">        for a given set of params. This should take `params` as its</span>
<span class="sd">        first arguments, all other arguments should be fixed ahead of time</span>
<span class="sd">        (ie: using `functools.partial`).</span>
<span class="sd">    log_prob_grad : Callable[[jax.Array], jax.Array]</span>
<span class="sd">        Function that returns the gradient log probability of the model</span>
<span class="sd">        for a given set of params. This should take `params` as its</span>
<span class="sd">        first arguments, all other arguments should be fixed ahead of time</span>
<span class="sd">        (ie: using `functools.partial`). The returned gradient should have</span>
<span class="sd">        shape `(len(params),)`.</span>
<span class="sd">    num_steps : int</span>
<span class="sd">        The number of steps to run the chain for.</span>
<span class="sd">    num_leaps : int</span>
<span class="sd">        The number of leapfrog steps to run at each step of the chain.</span>
<span class="sd">    step_size : float</span>
<span class="sd">        The step size to use.</span>
<span class="sd">        At each leapfrog step the parameters will evolve by `step_size`*`momentum`.</span>
<span class="sd">    comm : MPI.Intracomm</span>
<span class="sd">        The MPI comm object to use.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    chain : jax.Array</span>
<span class="sd">        The chain of samples.</span>
<span class="sd">        Will have shape `(num_steps, len(params))` in the rank 0 task.</span>
<span class="sd">        Note that on tasks with rank other than 0 the actual</span>
<span class="sd">        chain is not returned, instead a dummy array of size `(0,)` is</span>
<span class="sd">        returned.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>
    <span class="n">vnorm</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">vmap</span><span class="p">(</span>
        <span class="n">partial</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">npar</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">ones</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npar</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_leap</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="n">params</span><span class="p">,</span> <span class="n">momentum</span> <span class="o">=</span> <span class="n">args</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">log_prob_grad</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>  <span class="c1"># kick</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">step_size</span> <span class="o">*</span> <span class="n">momentum</span><span class="p">)</span>  <span class="c1"># drift</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">step_size</span> <span class="o">*</span> <span class="n">log_prob_grad</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>  <span class="c1"># kick</span>

        <span class="k">return</span> <span class="n">params</span><span class="p">,</span> <span class="n">momentum</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_sample</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">barrier</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">comm</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">uniform_key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># generate random momentum</span>
        <span class="n">momentum</span> <span class="o">=</span> <span class="n">vnorm</span><span class="p">(</span><span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">npar</span><span class="p">))</span>
        <span class="n">new_params</span><span class="p">,</span> <span class="n">new_momentum</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">fori_loop</span><span class="p">(</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">num_leaps</span><span class="p">,</span> <span class="n">_leap</span><span class="p">,</span> <span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">momentum</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># MH correction</span>
        <span class="n">dpe</span> <span class="o">=</span> <span class="n">log_prob</span><span class="p">(</span><span class="n">new_params</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_prob</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="n">dke</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">new_momentum</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">momentum</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">log_accept</span> <span class="o">=</span> <span class="n">dke</span> <span class="o">+</span> <span class="n">dpe</span>
        <span class="n">accept_prob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_accept</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">accept</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">uniform_key</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">accept_prob</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">accept</span> <span class="o">*</span> <span class="n">ones</span><span class="p">,</span> <span class="n">new_params</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">accept_prob</span>

    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">l_sample</span> <span class="o">=</span> <span class="n">_sample</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    <span class="n">c_sample</span> <span class="o">=</span> <span class="n">l_sample</span><span class="o">.</span><span class="n">compile</span><span class="p">()</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Compiled MC sample function in </span><span class="si">{</span><span class="n">t1</span><span class="o">-</span><span class="n">t0</span><span class="si">}</span><span class="s2"> s&quot;</span><span class="p">)</span>

    <span class="n">chain</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accept_prob</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_steps</span><span class="p">),</span> <span class="n">disable</span><span class="o">=</span><span class="p">(</span><span class="n">rank</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">prob</span> <span class="o">=</span> <span class="n">c_sample</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">chain</span> <span class="o">+=</span> <span class="p">[</span><span class="n">params</span><span class="p">]</span>
            <span class="n">accept_prob</span> <span class="o">+=</span> <span class="p">[</span><span class="n">prob</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">vstack</span><span class="p">(</span><span class="n">chain</span><span class="p">)</span>
        <span class="n">accept_prob</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accept_prob</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accepted </span><span class="si">{</span><span class="n">accept_prob</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="si">:</span><span class="s2">.2%</span><span class="si">}</span><span class="s2"> of samples&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">chain</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chain</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="witch.fitting.invsafe" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invsafe</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Safe SVD based psuedo-inversion of the matrix.
This zeros out modes that are too small when inverting.
Use with caution in cases where you really care about what the inverse is.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>matrix</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The matrix to invert.
Should be a <code>(n, n)</code> array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thresh</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold at which to zero out a mode.</p>
              </div>
            </td>
            <td>
                  <code>1e-14</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>invmat</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The inverted matrix.
Same shape as <code>matrix</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>witch/fitting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">invsafe</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Safe SVD based psuedo-inversion of the matrix.</span>
<span class="sd">    This zeros out modes that are too small when inverting.</span>
<span class="sd">    Use with caution in cases where you really care about what the inverse is.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : jax.Array</span>
<span class="sd">        The matrix to invert.</span>
<span class="sd">        Should be a `(n, n)` array.</span>
<span class="sd">    thresh : float, default: 1e-14</span>
<span class="sd">        Threshold at which to zero out a mode.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    invmat: jax.Array</span>
<span class="sd">        The inverted matrix.</span>
<span class="sd">        Same shape as `matrix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">s_inv</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">s</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">s</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">s_inv</span><span class="p">),</span> <span class="n">jnp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">u</span><span class="p">)))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="witch.fitting.invscale" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">invscale</span><span class="p">(</span><span class="n">matrix</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Invert and rescale a matrix by the diagonal.
This uses <code>invsafe</code> for the inversion.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>Parameters</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>matrix</code>
            </td>
            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The matrix to invert and sxane.
Should be a <code>(n, n)</code> array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>thresh</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Threshold for <code>invsafe</code>.
See that function for more info.</p>
              </div>
            </td>
            <td>
                  <code>1e-14</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>invmat</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The inverted and rescaled matrix.
Same shape as <code>matrix</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>witch/fitting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
<span class="k">def</span><span class="w"> </span><span class="nf">invscale</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">thresh</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e-14</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Invert and rescale a matrix by the diagonal.</span>
<span class="sd">    This uses `invsafe` for the inversion.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    matrix : jax.Array</span>
<span class="sd">        The matrix to invert and sxane.</span>
<span class="sd">        Should be a `(n, n)` array.</span>
<span class="sd">    thresh : float, default: 1e-14</span>
<span class="sd">        Threshold for `invsafe`.</span>
<span class="sd">        See that function for more info.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    invmat: jax.Array</span>
<span class="sd">        The inverted and rescaled matrix.</span>
<span class="sd">        Same shape as `matrix`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">diag</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>
    <span class="n">vec</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">diag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">diag</span><span class="p">)),</span> <span class="mf">1e-10</span><span class="p">))</span>
    <span class="n">mm</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">mm</span> <span class="o">*</span> <span class="n">invsafe</span><span class="p">(</span><span class="n">mm</span> <span class="o">*</span> <span class="n">matrix</span><span class="p">,</span> <span class="n">thresh</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h2 id="witch.fitting.run_mcmc" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run_mcmc</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">num_leaps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span> <span class="n">sample_which</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span></code>

</h2>


    <div class="doc doc-contents ">

        <p>Run MCMC using the <code>emcee</code> package to estimate the posterior for our model.
Currently this function only support flat priors, but more will be supported
down the line. In order to ensure accuracy of the noise model used, it is
reccomended that you run at least one round of <code>fit_tods</code> followed by noise
reestimation before this function.</p>
<p>This is MPI aware.
Eventually this will be replaced with something more jaxy.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>model</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="Model


  
      dataclass
   (witch.containers.Model)" href="../containers/#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model to run MCMC on.
We expect that all parameters in this model have priors defined.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dataset</code>
            </td>
            <td>
                  <code><a class="autorefs autorefs-internal" title="DataSet


  
      dataclass
   (witch.dataset.DataSet)" href="../dataset/#witch.dataset.DataSet">DataSet</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The dataset to compute the model posterior with.
The <code>dataset.datavec.comm</code> object is used to fit in an MPI aware way.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_steps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of steps to run MCMC for.</p>
              </div>
            </td>
            <td>
                  <code>5000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>num_leaps</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of leapfrog steps to take at each sample.</p>
              </div>
            </td>
            <td>
                  <code>10</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>step_size</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The step size to use in the leapfrog algorithm.
This should be tuned to get an acceptance fraction of ~.65.</p>
              </div>
            </td>
            <td>
                  <code>0.02</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>default</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The step size to use in the leapfrog algorithm.
This should be tuned to get an acceptance fraction of ~.65.</p>
              </div>
            </td>
            <td>
                  <code>0.02</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>sample_which</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Sets which parameters to sample.
If this is &gt;= 0 then we will sample which ever parameters were
fit in that round of fitting.
If this is -1 then we will sample which ever parameters were fit
in the last round of fitting.
If this is -2 then any parameters that were ever fit will be sampled.
If this is &lt;= -3 or &gt;= <code>model.n_rounds</code> then all parameters are sampled.</p>
              </div>
            </td>
            <td>
                  <code>-1,</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="Model


  
      dataclass
   (witch.containers.Model)" href="../containers/#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model with MCMC estimated parameters and errors.
The parameters are estimated as the mean of the samples.
The errors are estimated as the standard deviation.
This also has the chi-squared of the estimated parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>flat_samples</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of samples from running MCMC.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>witch/fitting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run_mcmc</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">Model</span><span class="p">,</span>
    <span class="n">dataset</span><span class="p">:</span> <span class="n">DataSet</span><span class="p">,</span>
    <span class="n">num_steps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>
    <span class="n">num_leaps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
    <span class="n">step_size</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">,</span>
    <span class="n">sample_which</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Model</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run MCMC using the `emcee` package to estimate the posterior for our model.</span>
<span class="sd">    Currently this function only support flat priors, but more will be supported</span>
<span class="sd">    down the line. In order to ensure accuracy of the noise model used, it is</span>
<span class="sd">    reccomended that you run at least one round of `fit_tods` followed by noise</span>
<span class="sd">    reestimation before this function.</span>

<span class="sd">    This is MPI aware.</span>
<span class="sd">    Eventually this will be replaced with something more jaxy.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model : Model</span>
<span class="sd">        The model to run MCMC on.</span>
<span class="sd">        We expect that all parameters in this model have priors defined.</span>
<span class="sd">    dataset : DataSet</span>
<span class="sd">        The dataset to compute the model posterior with.</span>
<span class="sd">        The `dataset.datavec.comm` object is used to fit in an MPI aware way.</span>
<span class="sd">    num_steps : int, default: 5000</span>
<span class="sd">        The number of steps to run MCMC for.</span>
<span class="sd">    num_leaps: int, default: 10</span>
<span class="sd">        The number of leapfrog steps to take at each sample.</span>
<span class="sd">    step_size, default: .02</span>
<span class="sd">        The step size to use in the leapfrog algorithm.</span>
<span class="sd">        This should be tuned to get an acceptance fraction of ~.65.</span>
<span class="sd">    sample_which : int, default: -1,</span>
<span class="sd">        Sets which parameters to sample.</span>
<span class="sd">        If this is &gt;= 0 then we will sample which ever parameters were</span>
<span class="sd">        fit in that round of fitting.</span>
<span class="sd">        If this is -1 then we will sample which ever parameters were fit</span>
<span class="sd">        in the last round of fitting.</span>
<span class="sd">        If this is -2 then any parameters that were ever fit will be sampled.</span>
<span class="sd">        If this is &lt;= -3 or &gt;= `model.n_rounds` then all parameters are sampled.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : Model</span>
<span class="sd">        The model with MCMC estimated parameters and errors.</span>
<span class="sd">        The parameters are estimated as the mean of the samples.</span>
<span class="sd">        The errors are estimated as the standard deviation.</span>
<span class="sd">        This also has the chi-squared of the estimated parameters.</span>
<span class="sd">    flat_samples : jax.Array</span>
<span class="sd">        Array of samples from running MCMC.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">barrier</span><span class="p">(</span><span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
    <span class="n">rank</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">Get_rank</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">sample_which</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">sample_which</span> <span class="o">&lt;</span> <span class="n">model</span><span class="o">.</span><span class="n">n_rounds</span><span class="p">:</span>
        <span class="n">model</span><span class="o">.</span><span class="n">cur_round</span> <span class="o">=</span> <span class="n">sample_which</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_fit</span>
    <span class="k">elif</span> <span class="n">sample_which</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_fit</span>
    <span class="k">elif</span> <span class="n">sample_which</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2</span><span class="p">:</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">to_fit_ever</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit_ever</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">to_fit</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_fit</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">add_round</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">to_fit</span><span class="p">))</span>

    <span class="n">init_pars</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">init_errs</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">pars</span><span class="p">)</span>
    <span class="n">final_pars</span> <span class="o">=</span> <span class="n">init_pars</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">final_errs</span> <span class="o">=</span> <span class="n">init_errs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="n">prior_l</span><span class="p">,</span> <span class="n">prior_u</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">priors</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prior_l</span><span class="p">)</span> <span class="o">+</span> <span class="n">jnp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">prior_u</span><span class="p">))</span> <span class="o">/</span> <span class="mf">2.0</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">scale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">init_pars</span> <span class="o">=</span> <span class="n">init_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">scale</span><span class="p">)</span>
    <span class="n">npar</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">to_fit</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_inf</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_not_inf</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
        <span class="n">pars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">temp_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">init_errs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
        <span class="n">chisq</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span>
            <span class="n">temp_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">log_like</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">chisq</span>
        <span class="k">return</span> <span class="n">log_like</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_log_prob</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">init_pars</span><span class="o">=</span><span class="n">init_pars</span><span class="p">):</span>
        <span class="n">full_pars</span> <span class="o">=</span> <span class="n">init_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">full_pars</span> <span class="o">=</span> <span class="n">full_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">in_bounds</span> <span class="o">=</span> <span class="n">_prior_pars_fit</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">full_pars</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit</span><span class="p">))</span>
        <span class="n">log_prior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">log_prior</span><span class="p">),</span>
            <span class="n">_not_inf</span><span class="p">,</span>
            <span class="n">_is_inf</span><span class="p">,</span>
            <span class="n">full_pars</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_is_inf_grad</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">npar</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_not_inf_grad</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">scale</span><span class="p">):</span>
        <span class="n">pars</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">)</span>
        <span class="n">temp_model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">init_errs</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span>
            <span class="n">temp_model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">grad</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">grad</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>

    <span class="nd">@jax</span><span class="o">.</span><span class="n">jit</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_log_prob_grad</span><span class="p">(</span><span class="n">pars</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span> <span class="n">init_pars</span><span class="o">=</span><span class="n">init_pars</span><span class="p">):</span>
        <span class="n">full_pars</span> <span class="o">=</span> <span class="n">init_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">pars</span><span class="p">)</span>
        <span class="n">full_pars</span> <span class="o">=</span> <span class="n">full_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scale</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">in_bounds</span> <span class="o">=</span> <span class="n">_prior_pars_fit</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">priors</span><span class="p">,</span> <span class="n">full_pars</span><span class="p">,</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">to_fit</span><span class="p">))</span>
        <span class="n">log_prior</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">in_bounds</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">jnp</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jax</span><span class="o">.</span><span class="n">lax</span><span class="o">.</span><span class="n">cond</span><span class="p">(</span>
            <span class="n">jnp</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">log_prior</span><span class="p">),</span>
            <span class="n">_not_inf_grad</span><span class="p">,</span>
            <span class="n">_is_inf_grad</span><span class="p">,</span>
            <span class="n">full_pars</span><span class="p">,</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="n">scale</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="n">key</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">PRNGKey</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">key</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
    <span class="n">chain</span> <span class="o">=</span> <span class="n">hmc</span><span class="p">(</span>
        <span class="n">init_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
        <span class="n">_log_prob</span><span class="p">,</span>
        <span class="n">_log_prob_grad</span><span class="p">,</span>
        <span class="n">num_steps</span><span class="o">=</span><span class="n">num_steps</span><span class="p">,</span>
        <span class="n">num_leaps</span><span class="o">=</span><span class="n">num_leaps</span><span class="p">,</span>
        <span class="n">step_size</span><span class="o">=</span><span class="n">step_size</span><span class="p">,</span>
        <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">flat_samples</span> <span class="o">=</span> <span class="n">chain</span><span class="o">.</span><span class="n">at</span><span class="p">[:]</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">scale</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
    <span class="k">if</span> <span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">final_pars</span> <span class="o">=</span> <span class="n">final_pars</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">flat_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">final_errs</span> <span class="o">=</span> <span class="n">final_errs</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">to_fit</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">jnp</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">flat_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">final_pars</span><span class="p">,</span> <span class="n">token</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span>
        <span class="n">final_pars</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span>
    <span class="p">)</span>
    <span class="n">final_errs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mpi4jax</span><span class="o">.</span><span class="n">bcast</span><span class="p">(</span><span class="n">final_errs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">comm</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="o">.</span><span class="n">comm</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
        <span class="n">final_pars</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">(),</span> <span class="n">final_errs</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">(),</span> <span class="n">model</span><span class="o">.</span><span class="n">chisq</span>
    <span class="p">)</span>
    <span class="n">chisq</span><span class="p">,</span> <span class="o">*</span><span class="n">_</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">objective</span><span class="p">(</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datavec</span><span class="p">,</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mode</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">final_pars</span><span class="p">,</span> <span class="n">final_errs</span><span class="p">,</span> <span class="n">chisq</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">flat_samples</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>