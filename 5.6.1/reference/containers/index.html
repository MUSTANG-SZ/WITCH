
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://mustang-sz.github.io/WITCH/5.6.1/reference/containers/">
      
      
        <link rel="prev" href="../..">
      
      
        <link rel="next" href="../core/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>containers - WITCH</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#witch.containers" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="WITCH" class="md-header__button md-logo" aria-label="WITCH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            WITCH
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              containers
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="WITCH" class="md-nav__button md-logo" aria-label="WITCH" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    WITCH
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    API Reference
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    containers
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    containers
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#witch.containers" class="md-nav__link">
    <span class="md-ellipsis">
      containers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Model" class="md-nav__link">
    <span class="md-ellipsis">
      Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.errs" class="md-nav__link">
    <span class="md-ellipsis">
      errs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.model_grad" class="md-nav__link">
    <span class="md-ellipsis">
      model_grad
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.n_struct" class="md-nav__link">
    <span class="md-ellipsis">
      n_struct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.par_names" class="md-nav__link">
    <span class="md-ellipsis">
      par_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.pars" class="md-nav__link">
    <span class="md-ellipsis">
      pars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_fit" class="md-nav__link">
    <span class="md-ellipsis">
      to_fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_fit_ever" class="md-nav__link">
    <span class="md-ellipsis">
      to_fit_ever
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.from_cfg" class="md-nav__link">
    <span class="md-ellipsis">
      from_cfg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.minkasi_helper" class="md-nav__link">
    <span class="md-ellipsis">
      minkasi_helper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.remove_struct" class="md-nav__link">
    <span class="md-ellipsis">
      remove_struct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_tod" class="md-nav__link">
    <span class="md-ellipsis">
      to_tod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_tod_grad" class="md-nav__link">
    <span class="md-ellipsis">
      to_tod_grad
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Parameter" class="md-nav__link">
    <span class="md-ellipsis">
      Parameter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#witch.containers.Parameter.fit_ever" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ever
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Structure" class="md-nav__link">
    <span class="md-ellipsis">
      Structure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    core
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../fitter/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    fitter
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../forward_modeling/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    forward_modeling
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../mapmaking/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    mapmaking
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../plotting/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    plotting
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../structure/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    structure
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../utils/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    utils
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#witch.containers" class="md-nav__link">
    <span class="md-ellipsis">
      containers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Model" class="md-nav__link">
    <span class="md-ellipsis">
      Model
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Model">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.errs" class="md-nav__link">
    <span class="md-ellipsis">
      errs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.model" class="md-nav__link">
    <span class="md-ellipsis">
      model
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.model_grad" class="md-nav__link">
    <span class="md-ellipsis">
      model_grad
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.n_struct" class="md-nav__link">
    <span class="md-ellipsis">
      n_struct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.par_names" class="md-nav__link">
    <span class="md-ellipsis">
      par_names
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.pars" class="md-nav__link">
    <span class="md-ellipsis">
      pars
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.priors" class="md-nav__link">
    <span class="md-ellipsis">
      priors
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_fit" class="md-nav__link">
    <span class="md-ellipsis">
      to_fit
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_fit_ever" class="md-nav__link">
    <span class="md-ellipsis">
      to_fit_ever
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.from_cfg" class="md-nav__link">
    <span class="md-ellipsis">
      from_cfg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.load" class="md-nav__link">
    <span class="md-ellipsis">
      load
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.minkasi_helper" class="md-nav__link">
    <span class="md-ellipsis">
      minkasi_helper
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.remove_struct" class="md-nav__link">
    <span class="md-ellipsis">
      remove_struct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.save" class="md-nav__link">
    <span class="md-ellipsis">
      save
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_tod" class="md-nav__link">
    <span class="md-ellipsis">
      to_tod
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.to_tod_grad" class="md-nav__link">
    <span class="md-ellipsis">
      to_tod_grad
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#witch.containers.Model.update" class="md-nav__link">
    <span class="md-ellipsis">
      update
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Parameter" class="md-nav__link">
    <span class="md-ellipsis">
      Parameter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#witch.containers.Parameter.fit_ever" class="md-nav__link">
    <span class="md-ellipsis">
      fit_ever
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#witch.containers.Structure" class="md-nav__link">
    <span class="md-ellipsis">
      Structure
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>containers</h1>

<div class="doc doc-object doc-module">



<a id="witch.containers"></a>
    <div class="doc doc-contents first">

      <p>Data classes for describing models in a structured way.</p>



  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h2 id="witch.containers.Model" class="doc doc-heading">
            <code>Model</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>Dataclass to describe a model.
This includes some caching features that improve performance when fitting.
Note that because of the caching dynamically modifying what structures compose
the model may not work as intended so beware.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.name">name</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the model.
This is used for display purposes only.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.structures">structures</span></code></td>
            <td>
                  <code>list[<a class="autorefs autorefs-internal" title="witch.containers.Structure" href="#witch.containers.Structure">Structure</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The structures that compose the model.
Will be sorted to match <code>core.ORDER</code> once initialized.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.xyz">xyz</span></code></td>
            <td>
                  <code>tuple[<span title="jax.Array">Array</span>, <span title="jax.Array">Array</span>, <span title="jax.Array">Array</span>, float, float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Defines the grid used by model computation.
The first three elements are a sparse 3D grid in arcseconds,
with the first two elements being RA and Dec respectively and the third
element being the LOS. The last two elements are the model center in Ra and Dec
(also in arcseconds). The structure functions use this as the coordinate to reference
<code>dx</code> and <code>dy</code> to.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.dz">dz</span></code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The LOS integration factor.
Should minimally be the pixel size in arcseconds along the LOS,
but can also include additional factors for performing unit conversions.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.beam">beam</span></code></td>
            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The beam to convolve the model with.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.n_rounds">n_rounds</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>How many rounds of fitting to perform.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.pix_size">pix_size</span></code></td>
            <td>
                  <code>float | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pix size of corresponding map</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.lims">lims</span></code></td>
            <td>
                  <code>list[float, float, float, float] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of ra_min, ra_max, dec_min, dec_max for map model was fit to</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.cur_round">cur_round</span></code></td>
            <td>
                  <code>int, default: 0</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Which round of fitting we are currently in,
rounds are 0 indexed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.chisq">chisq</span></code></td>
            <td>
                  <code>float, default: np.inf</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The chi-squared of this model relative to some data.
Used when fitting.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Model.original_order">original_order</span></code></td>
            <td>
                  <code>list[int]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The original order than the structures in <code>structures</code> were inputted.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>witch/containers.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataclass to describe a model.</span>
<span class="sd">    This includes some caching features that improve performance when fitting.</span>
<span class="sd">    Note that because of the caching dynamically modifying what structures compose</span>
<span class="sd">    the model may not work as intended so beware.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the model.</span>
<span class="sd">        This is used for display purposes only.</span>
<span class="sd">    structures : list[Structure]</span>
<span class="sd">        The structures that compose the model.</span>
<span class="sd">        Will be sorted to match `core.ORDER` once initialized.</span>
<span class="sd">    xyz : tuple[jax.Array, jax.Array, jax.Array, float, float]</span>
<span class="sd">        Defines the grid used by model computation.</span>
<span class="sd">        The first three elements are a sparse 3D grid in arcseconds,</span>
<span class="sd">        with the first two elements being RA and Dec respectively and the third</span>
<span class="sd">        element being the LOS. The last two elements are the model center in Ra and Dec</span>
<span class="sd">        (also in arcseconds). The structure functions use this as the coordinate to reference</span>
<span class="sd">        `dx` and `dy` to.</span>
<span class="sd">    dz : float</span>
<span class="sd">        The LOS integration factor.</span>
<span class="sd">        Should minimally be the pixel size in arcseconds along the LOS,</span>
<span class="sd">        but can also include additional factors for performing unit conversions.</span>
<span class="sd">    beam : jax.Array</span>
<span class="sd">        The beam to convolve the model with.</span>
<span class="sd">    n_rounds : int</span>
<span class="sd">        How many rounds of fitting to perform.</span>
<span class="sd">    pix_size : float | None</span>
<span class="sd">        Pix size of corresponding map</span>
<span class="sd">    lims : list[float, float, float, float] | None</span>
<span class="sd">        List of ra_min, ra_max, dec_min, dec_max for map model was fit to</span>
<span class="sd">    cur_round : int, default: 0</span>
<span class="sd">        Which round of fitting we are currently in,</span>
<span class="sd">        rounds are 0 indexed.</span>
<span class="sd">    chisq : float, default: np.inf</span>
<span class="sd">        The chi-squared of this model relative to some data.</span>
<span class="sd">        Used when fitting.</span>
<span class="sd">    original_order : list[int]</span>
<span class="sd">        The original order than the structures in `structures` were inputted.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">structures</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Structure</span><span class="p">]</span>
    <span class="n">xyz</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>  <span class="c1"># arcseconds</span>
    <span class="n">dz</span><span class="p">:</span> <span class="nb">float</span>  <span class="c1"># arcseconds * unknown</span>
    <span class="n">beam</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span>
    <span class="n">n_rounds</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">pix_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">lims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">cur_round</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">chisq</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">original_order</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">init</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make sure the structure is in the order that core expects</span>
        <span class="n">structure_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span>
            <span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">ORDER</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span> <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structures</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">structure_idx</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">original_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">structure_idx</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__set_attr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;cur_round&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_grad&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">rep</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Round </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_round</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2"> out of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_rounds</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_order</span><span class="p">:</span>
            <span class="n">struct</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">rep</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">struct</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">rep</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="s2">&quot;</span><span class="se">\t\t</span><span class="s2">&quot;</span>
                    <span class="o">+</span> <span class="n">par</span><span class="o">.</span><span class="n">name</span>
                    <span class="o">+</span> <span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="n">par</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_round</span><span class="p">]</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">prior</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">prior</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot; = &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;  &quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">par</span><span class="o">.</span><span class="n">err</span><span class="p">)</span>
                    <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="n">rep</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;chisq is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">chisq</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="n">rep</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">n_struct</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Number of each type of structures in the model.</span>
<span class="sd">        Note that this is cached.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        n_struct : list[int]</span>
<span class="sd">            `n_struct[i]` is the number of `core.ORDER[i]`</span>
<span class="sd">            structures in this model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_struct</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">ORDER</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">ORDER</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">structure</span><span class="p">)</span>
            <span class="n">n_struct</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">n_struct</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pars</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current parameter values.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pars : list[float]</span>
<span class="sd">            The parameter values in the order expected by `core.model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">pars</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pars</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">par_names</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the names of all parameters.</span>
<span class="sd">        Note that this is cached.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        par_names : list[str]</span>
<span class="sd">            Parameter names in the same order as `pars`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">par_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">par_names</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">par_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">errs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the current parameter errors.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        errs : list[float]</span>
<span class="sd">            The errors in the same order as vals.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">errs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">errs</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">err</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">errs</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">priors</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the priors for all parameters.</span>
<span class="sd">        Note that this is cached.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        priors : list[Optional[tuple[float, float]]]</span>
<span class="sd">            Parameter priors in the same order as `pars`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">priors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">priors</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">prior</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">priors</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">to_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get which parameters we want to fit for the current round.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        to_fit : list[bool]</span>
<span class="sd">            `to_fit[i]` is True if we want to fit the `i`&#39;th parameter</span>
<span class="sd">            in the current round.</span>
<span class="sd">            This is in the same order as `pars`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">to_fit</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="n">parameter</span><span class="o">.</span><span class="n">fit</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cur_round</span><span class="p">]</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="n">to_fit</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">to_fit_ever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check which parameters we ever fit.</span>
<span class="sd">        Note that this is cached.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        to_fit_ever : list[bool]</span>
<span class="sd">            `to_fit[i]` is True if we ever want to fit the `i`&#39;th parameter.</span>
<span class="sd">            This is in the same order as `pars`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">to_fit</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="n">to_fit</span> <span class="o">+=</span> <span class="p">[</span><span class="n">parameter</span><span class="o">.</span><span class="n">fit_ever</span> <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">structure</span><span class="o">.</span><span class="n">parameters</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">to_fit</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The evaluated model, see `core.model` for details.</span>
<span class="sd">        Note that this is cached, but is automatically reset whenever</span>
<span class="sd">        `update` is called or `cur_round` changes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : jax.Array</span>
<span class="sd">            The model evaluted on `xyz` with the current values of `pars`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">model</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_struct</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">model_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The evaluated model and its gradient, see `core.model_grad` for details.</span>
<span class="sd">        Note that this is cached, but is automatically reset whenever</span>
<span class="sd">        `update` is called or `cur_round` changes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : jax.Array</span>
<span class="sd">            The model evaluted on `xyz` with the current values of `pars`.</span>
<span class="sd">        grad : jax.Array</span>
<span class="sd">            The gradient evaluted on `xyz` with the current values of `pars`.</span>
<span class="sd">            Has shape `(len(pars),) + model.shape`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">argnums</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">to_fit</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">core</span><span class="o">.</span><span class="n">ARGNUM_SHIFT</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">model_grad</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">,</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_struct</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">beam</span><span class="p">,</span>
            <span class="n">argnums</span><span class="p">,</span>
            <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project the model into a TOD.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dx : ArrayLike</span>
<span class="sd">            The RA TOD in arcseconds.</span>
<span class="sd">        dy : ArrayLike</span>
<span class="sd">            The Dec TOD in arcseconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tod : jax.Array</span>
<span class="sd">            The model as a TOD.</span>
<span class="sd">            Same shape as dx.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">to_tod_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Project the model and gradint into a TOD.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dx : ArrayLike</span>
<span class="sd">            The RA TOD in arcseconds.</span>
<span class="sd">        dy : ArrayLike</span>
<span class="sd">            The Dec TOD in arcseconds.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        tod : jax.Array</span>
<span class="sd">            The model as a TOD.</span>
<span class="sd">            Same shape as dx.</span>
<span class="sd">        grad_tod : jax.Array</span>
<span class="sd">            The gradient as a TOD.</span>
<span class="sd">            Has shape `(len(pars),) + dx.shape`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span><span class="p">,</span> <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_grad</span>
        <span class="n">tod</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
            <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">model</span>
        <span class="p">)</span>
        <span class="n">grad_tod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">(</span>
                    <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
                        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">_grad</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">_fit</span>
                    <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
                <span class="p">)</span>
                <span class="k">for</span> <span class="n">_grad</span><span class="p">,</span> <span class="n">_fit</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_fit</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">tod</span><span class="p">,</span> <span class="n">grad_tod</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">errs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">chisq</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update the parameter values and errors as well as the model chi-squared.</span>
<span class="sd">        This also resets the cache on `model` and `model_tod`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vals : Sequence[float]</span>
<span class="sd">            The new parameter values.</span>
<span class="sd">            Should be in the same order as `pars`.</span>
<span class="sd">        errs : Sequence[float]</span>
<span class="sd">            The new parameter errors.</span>
<span class="sd">            Should be in the same order as `pars`.</span>
<span class="sd">        chisq : float</span>
<span class="sd">            The new chi-squared.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_grad&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
                <span class="n">par</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="n">par</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">errs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
                <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq</span>

    <span class="k">def</span> <span class="nf">minkasi_helper</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">tod</span><span class="p">:</span> <span class="n">Tod</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Helper function to work with minkasi fitting routines.</span>
<span class="sd">        You should never need to touch this yourself, just pass it to</span>
<span class="sd">        `minkasi.fitting.fit_timestreams_with_derivs_manyfun`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        params : NDArray[np.floating]</span>
<span class="sd">            Array of model parameters.</span>
<span class="sd">            Should be in the same order as `pars`</span>
<span class="sd">        tod : Tod</span>
<span class="sd">            A minkasi tod instance.</span>
<span class="sd">            &#39;dx&#39; and &#39;dy&#39; must be in tod.info and be in radians.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        grad : NDArray[np.floating]</span>
<span class="sd">            The gradient of the model with respect to the model parameters.</span>
<span class="sd">        pred : NDArray[np.floating]</span>
<span class="sd">            The model with the specified substructure.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>

        <span class="n">pred_tod</span><span class="p">,</span> <span class="n">grad_tod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_tod_grad</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
        <span class="n">pred_tod</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">pred_tod</span><span class="p">)</span>
        <span class="n">grad_tod</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">grad_tod</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">grad_tod</span><span class="p">,</span> <span class="n">pred_tod</span>

    <span class="k">def</span> <span class="nf">remove_struct</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">struct_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove structure by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        struct_name : str</span>
<span class="sd">            Name of struct to be removed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct_name</span><span class="p">):</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">i</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">{}</span><span class="s2"> not in structure names&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct_name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;to_fit_ever&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_struct&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;priors&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;par_names&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Serialize the model to a file with dill.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The file to save to.</span>
<span class="sd">            Does not check to see if the path is valid.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Load the model from a file with dill.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        path : str</span>
<span class="sd">            The path to the saved model.</span>
<span class="sd">            Does not check to see if the path is valid.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : Model</span>
<span class="sd">            The loaded model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_cfg</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
        <span class="n">pix_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an instance of model from a witcher config.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cfg : dict</span>
<span class="sd">            The config loaded into a dict.</span>
<span class="sd">        pix_size : float | None</span>
<span class="sd">            Pix size of corresponding map</span>
<span class="sd">        lims : list[float, float, float, float] | None</span>
<span class="sd">            List of ra_min, ra_max, dec_min, dec_max for map model was fit to</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        model : Model</span>
<span class="sd">            The model described by the config.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Do imports</span>
        <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imports&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="nb">locals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                    <span class="nb">locals</span><span class="p">()[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expect import name to be a string or a list&quot;</span><span class="p">)</span>

        <span class="c1"># Load constants</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">name</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constants&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">}</span>  <span class="c1"># pyright: ignore [reportUnusedVariable]</span>

        <span class="c1"># Get jax device</span>
        <span class="n">dev_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jax_device&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()[</span><span class="n">dev_id</span><span class="p">]</span>

        <span class="c1"># Setup coordindate stuff</span>
        <span class="n">r_map</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;r_map&quot;</span><span class="p">]))</span>
        <span class="n">dr</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;dr&quot;</span><span class="p">]))</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dz&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">)))</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;x0&quot;</span><span class="p">]))</span>
        <span class="n">y0</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;y0&quot;</span><span class="p">]))</span>

        <span class="n">xyz_host</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">make_grid</span><span class="p">(</span>
            <span class="n">r_map</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span><span class="p">,</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>
        <span class="p">)</span>
        <span class="n">xyz</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">xyz_host</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
        <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
        <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
        <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>

        <span class="c1"># Make beam</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">beam_double_gauss</span><span class="p">(</span>
            <span class="n">dr</span><span class="p">,</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;fwhm1&quot;</span><span class="p">])),</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;amp1&quot;</span><span class="p">])),</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;fwhm2&quot;</span><span class="p">])),</span>
            <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;amp2&quot;</span><span class="p">])),</span>
        <span class="p">)</span>
        <span class="n">beam</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

        <span class="n">n_rounds</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">dz</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;unit_conversion&quot;</span><span class="p">]))</span>

        <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;structures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]))</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_fit&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_rounds</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                    <span class="n">fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_rounds</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_rounds</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;to_fit has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries but we only have </span><span class="si">{</span><span class="n">n_rounds</span><span class="si">}</span><span class="s2"> rounds&quot;</span>
                    <span class="p">)</span>
                <span class="n">priors</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priors&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">priors</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">priors</span><span class="p">))</span>
                <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Parameter</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">priors</span><span class="p">))</span>
            <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Structure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">],</span> <span class="n">parameters</span><span class="p">))</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">structure</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">])</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structures</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">n_rounds</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">lims</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.errs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">errs</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get the current parameter errors.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>errs</code></td>            <td>
                  <code>list[float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The errors in the same order as vals.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.model" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model</span><span class="p">:</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>The evaluated model, see <code>core.model</code> for details.
Note that this is cached, but is automatically reset whenever
<code>update</code> is called or <code>cur_round</code> changes.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model evaluted on <code>xyz</code> with the current values of <code>pars</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.model_grad" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">model_grad</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>The evaluated model and its gradient, see <code>core.model_grad</code> for details.
Note that this is cached, but is automatically reset whenever
<code>update</code> is called or <code>cur_round</code> changes.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model evaluted on <code>xyz</code> with the current values of <code>pars</code>.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>grad</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The gradient evaluted on <code>xyz</code> with the current values of <code>pars</code>.
Has shape <code>(len(pars),) + model.shape</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.n_struct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">n_struct</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Number of each type of structures in the model.
Note that this is cached.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>n_struct</code></td>            <td>
                  <code>list[int]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>n_struct[i]</code> is the number of <code>core.ORDER[i]</code>
structures in this model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.par_names" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">par_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get the names of all parameters.
Note that this is cached.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>par_names</code></td>            <td>
                  <code>list[str]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameter names in the same order as <code>pars</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.pars" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">pars</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get the current parameter values.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>pars</code></td>            <td>
                  <code>list[float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The parameter values in the order expected by <code>core.model</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.priors" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">priors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get the priors for all parameters.
Note that this is cached.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>priors</code></td>            <td>
                  <code>list[<span title="typing.Optional">Optional</span>[tuple[float, float]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parameter priors in the same order as <code>pars</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.to_fit" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_fit</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Get which parameters we want to fit for the current round.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>to_fit</code></td>            <td>
                  <code>list[bool]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>to_fit[i]</code> is True if we want to fit the <code>i</code>'th parameter
in the current round.
This is in the same order as <code>pars</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>

<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Model.to_fit_ever" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_fit_ever</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-cached"><code>cached</code></small>
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Check which parameters we ever fit.
Note that this is cached.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>to_fit_ever</code></td>            <td>
                  <code>list[bool]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p><code>to_fit[i]</code> is True if we ever want to fit the <code>i</code>'th parameter.
This is in the same order as <code>pars</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>



<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.from_cfg" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">from_cfg</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">pix_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">lims</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Create an instance of model from a witcher config.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>cfg</code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The config loaded into a dict.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>pix_size</code></td>
            <td>
                  <code>float | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Pix size of corresponding map</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>lims</code></td>
            <td>
                  <code>list[float, float, float, float] | None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of ra_min, ra_max, dec_min, dec_max for map model was fit to</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="witch.containers.Model" href="#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model described by the config.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">from_cfg</span><span class="p">(</span>
    <span class="bp">cls</span><span class="p">,</span>
    <span class="n">cfg</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
    <span class="n">pix_size</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create an instance of model from a witcher config.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cfg : dict</span>
<span class="sd">        The config loaded into a dict.</span>
<span class="sd">    pix_size : float | None</span>
<span class="sd">        Pix size of corresponding map</span>
<span class="sd">    lims : list[float, float, float, float] | None</span>
<span class="sd">        List of ra_min, ra_max, dec_min, dec_max for map model was fit to</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : Model</span>
<span class="sd">        The model described by the config.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Do imports</span>
    <span class="k">for</span> <span class="n">module</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;imports&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">module</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="nb">locals</span><span class="p">()[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mod</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
                <span class="nb">locals</span><span class="p">()[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Expect import name to be a string or a list&quot;</span><span class="p">)</span>

    <span class="c1"># Load constants</span>
    <span class="n">constants</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">const</span><span class="p">))</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;constants&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>  <span class="c1"># pyright: ignore [reportUnusedVariable]</span>

    <span class="c1"># Get jax device</span>
    <span class="n">dev_id</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jax_device&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">device</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">devices</span><span class="p">()[</span><span class="n">dev_id</span><span class="p">]</span>

    <span class="c1"># Setup coordindate stuff</span>
    <span class="n">r_map</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;r_map&quot;</span><span class="p">]))</span>
    <span class="n">dr</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;dr&quot;</span><span class="p">]))</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dz&quot;</span><span class="p">,</span> <span class="n">dr</span><span class="p">)))</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;x0&quot;</span><span class="p">]))</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;coords&quot;</span><span class="p">][</span><span class="s2">&quot;y0&quot;</span><span class="p">]))</span>

    <span class="n">xyz_host</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">make_grid</span><span class="p">(</span>
        <span class="n">r_map</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dr</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">x0</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span><span class="p">,</span> <span class="n">y0</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>
    <span class="p">)</span>
    <span class="n">xyz</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">xyz_host</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>
    <span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
    <span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>
    <span class="n">xyz</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">block_until_ready</span><span class="p">()</span>

    <span class="c1"># Make beam</span>
    <span class="n">beam</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">beam_double_gauss</span><span class="p">(</span>
        <span class="n">dr</span><span class="p">,</span>
        <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;fwhm1&quot;</span><span class="p">])),</span>
        <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;amp1&quot;</span><span class="p">])),</span>
        <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;fwhm2&quot;</span><span class="p">])),</span>
        <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;beam&quot;</span><span class="p">][</span><span class="s2">&quot;amp2&quot;</span><span class="p">])),</span>
    <span class="p">)</span>
    <span class="n">beam</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_put</span><span class="p">(</span><span class="n">beam</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span>

    <span class="n">n_rounds</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;n_rounds&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">dz</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;unit_conversion&quot;</span><span class="p">]))</span>

    <span class="n">structures</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">][</span><span class="s2">&quot;structures&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">par_name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]))</span>
            <span class="n">fit</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;to_fit&quot;</span><span class="p">,</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_rounds</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fit</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
                <span class="n">fit</span> <span class="o">=</span> <span class="p">[</span><span class="n">fit</span><span class="p">]</span> <span class="o">*</span> <span class="n">n_rounds</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span> <span class="o">!=</span> <span class="n">n_rounds</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;to_fit has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span><span class="si">}</span><span class="s2"> entries but we only have </span><span class="si">{</span><span class="n">n_rounds</span><span class="si">}</span><span class="s2"> rounds&quot;</span>
                <span class="p">)</span>
            <span class="n">priors</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;priors&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">priors</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">priors</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">priors</span><span class="p">))</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Parameter</span><span class="p">(</span><span class="n">par_name</span><span class="p">,</span> <span class="n">fit</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">priors</span><span class="p">))</span>
        <span class="n">structures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Structure</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structure</span><span class="p">[</span><span class="s2">&quot;structure&quot;</span><span class="p">],</span> <span class="n">parameters</span><span class="p">))</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">structure</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">structure</span> <span class="ow">in</span> <span class="n">structures</span><span class="p">])</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">structures</span><span class="p">,</span> <span class="n">xyz</span><span class="p">,</span> <span class="n">dz</span><span class="p">,</span> <span class="n">beam</span><span class="p">,</span> <span class="n">n_rounds</span><span class="p">,</span> <span class="n">pix_size</span><span class="p">,</span> <span class="n">lims</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.load" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-classmethod"><code>classmethod</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Load the model from a file with dill.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the saved model.
Does not check to see if the path is valid.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>model</code></td>            <td>
                  <code><a class="autorefs autorefs-internal" title="witch.containers.Model" href="#witch.containers.Model">Model</a></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded model.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the model from a file with dill.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The path to the saved model.</span>
<span class="sd">        Does not check to see if the path is valid.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model : Model</span>
<span class="sd">        The loaded model.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.minkasi_helper" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">minkasi_helper</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">tod</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Helper function to work with minkasi fitting routines.
You should never need to touch this yourself, just pass it to
<code>minkasi.fitting.fit_timestreams_with_derivs_manyfun</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>params</code></td>
            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Array of model parameters.
Should be in the same order as <code>pars</code></p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>tod</code></td>
            <td>
                  <code><span title="minkasi.tods.Tod">Tod</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A minkasi tod instance.
'dx' and 'dy' must be in tod.info and be in radians.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>grad</code></td>            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The gradient of the model with respect to the model parameters.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>pred</code></td>            <td>
                  <code><span title="numpy.typing.NDArray">NDArray</span>[<span title="numpy.floating">floating</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model with the specified substructure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">minkasi_helper</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">tod</span><span class="p">:</span> <span class="n">Tod</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">],</span> <span class="n">NDArray</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floating</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Helper function to work with minkasi fitting routines.</span>
<span class="sd">    You should never need to touch this yourself, just pass it to</span>
<span class="sd">    `minkasi.fitting.fit_timestreams_with_derivs_manyfun`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    params : NDArray[np.floating]</span>
<span class="sd">        Array of model parameters.</span>
<span class="sd">        Should be in the same order as `pars`</span>
<span class="sd">    tod : Tod</span>
<span class="sd">        A minkasi tod instance.</span>
<span class="sd">        &#39;dx&#39; and &#39;dy&#39; must be in tod.info and be in radians.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    grad : NDArray[np.floating]</span>
<span class="sd">        The gradient of the model with respect to the model parameters.</span>
<span class="sd">    pred : NDArray[np.floating]</span>
<span class="sd">        The model with the specified substructure.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dx&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">tod</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;dy&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">wu</span><span class="o">.</span><span class="n">rad_to_arcsec</span>

    <span class="n">pred_tod</span><span class="p">,</span> <span class="n">grad_tod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_tod_grad</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span>
    <span class="n">pred_tod</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">pred_tod</span><span class="p">)</span>
    <span class="n">grad_tod</span> <span class="o">=</span> <span class="n">jax</span><span class="o">.</span><span class="n">device_get</span><span class="p">(</span><span class="n">grad_tod</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grad_tod</span><span class="p">,</span> <span class="n">pred_tod</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.remove_struct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">remove_struct</span><span class="p">(</span><span class="n">struct_name</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Remove structure by name.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>struct_name</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of struct to be removed.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">remove_struct</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span>
    <span class="n">struct_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Self</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Remove structure by name.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    struct_name : str</span>
<span class="sd">        Name of struct to be removed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">structure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">structure</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">struct_name</span><span class="p">):</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">i</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Error: </span><span class="si">{}</span><span class="s2"> not in structure names&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct_name</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;to_fit_ever&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;n_struct&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;priors&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;par_names&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">__post_init__</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.save" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">save</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Serialize the model to a file with dill.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>path</code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The file to save to.
Does not check to see if the path is valid.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Serialize the model to a file with dill.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        The file to save to.</span>
<span class="sd">        Does not check to see if the path is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.to_tod" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_tod</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Project the model into a TOD.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>dx</code></td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The RA TOD in arcseconds.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>dy</code></td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Dec TOD in arcseconds.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tod</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model as a TOD.
Same shape as dx.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_tod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Project the model into a TOD.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dx : ArrayLike</span>
<span class="sd">        The RA TOD in arcseconds.</span>
<span class="sd">    dy : ArrayLike</span>
<span class="sd">        The Dec TOD in arcseconds.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tod : jax.Array</span>
<span class="sd">        The model as a TOD.</span>
<span class="sd">        Same shape as dx.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.to_tod_grad" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">to_tod_grad</span><span class="p">(</span><span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Project the model and gradint into a TOD.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>dx</code></td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The RA TOD in arcseconds.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>dy</code></td>
            <td>
                  <code><span title="jax.typing.ArrayLike">ArrayLike</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The Dec TOD in arcseconds.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>tod</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model as a TOD.
Same shape as dx.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>grad_tod</code></td>            <td>
                  <code><span title="jax.Array">Array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The gradient as a TOD.
Has shape <code>(len(pars),) + dx.shape</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">to_tod_grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dx</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">dy</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">,</span> <span class="n">jax</span><span class="o">.</span><span class="n">Array</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Project the model and gradint into a TOD.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dx : ArrayLike</span>
<span class="sd">        The RA TOD in arcseconds.</span>
<span class="sd">    dy : ArrayLike</span>
<span class="sd">        The Dec TOD in arcseconds.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tod : jax.Array</span>
<span class="sd">        The model as a TOD.</span>
<span class="sd">        Same shape as dx.</span>
<span class="sd">    grad_tod : jax.Array</span>
<span class="sd">        The gradient as a TOD.</span>
<span class="sd">        Has shape `(len(pars),) + dx.shape`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">grad</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_grad</span>
    <span class="n">tod</span> <span class="o">=</span> <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
        <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">model</span>
    <span class="p">)</span>
    <span class="n">grad_tod</span> <span class="o">=</span> <span class="n">jnp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">(</span>
                <span class="n">wu</span><span class="o">.</span><span class="n">bilinear_interp</span><span class="p">(</span>
                    <span class="n">dx</span><span class="p">,</span> <span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyz</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">_grad</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">_fit</span>
                <span class="k">else</span> <span class="n">jnp</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">tod</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">_grad</span><span class="p">,</span> <span class="n">_fit</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">grad</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">to_fit</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">tod</span><span class="p">,</span> <span class="n">grad_tod</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="witch.containers.Model.update" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">update</span><span class="p">(</span><span class="n">vals</span><span class="p">,</span> <span class="n">errs</span><span class="p">,</span> <span class="n">chisq</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

      <p>Update the parameter values and errors as well as the model chi-squared.
This also resets the cache on <code>model</code> and <code>model_tod</code>.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>vals</code></td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new parameter values.
Should be in the same order as <code>pars</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>errs</code></td>
            <td>
                  <code><span title="typing.Sequence">Sequence</span>[float]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new parameter errors.
Should be in the same order as <code>pars</code>.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>chisq</code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The new chi-squared.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>witch/containers.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vals</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">errs</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">chisq</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the parameter values and errors as well as the model chi-squared.</span>
<span class="sd">    This also resets the cache on `model` and `model_tod`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vals : Sequence[float]</span>
<span class="sd">        The new parameter values.</span>
<span class="sd">        Should be in the same order as `pars`.</span>
<span class="sd">    errs : Sequence[float]</span>
<span class="sd">        The new parameter errors.</span>
<span class="sd">        Should be in the same order as `pars`.</span>
<span class="sd">    chisq : float</span>
<span class="sd">        The new chi-squared.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pars</span><span class="p">,</span> <span class="n">vals</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;model_grad&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">struct</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">structures</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">par</span> <span class="ow">in</span> <span class="n">struct</span><span class="o">.</span><span class="n">parameters</span><span class="p">:</span>
            <span class="n">par</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vals</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">par</span><span class="o">.</span><span class="n">err</span> <span class="o">=</span> <span class="n">errs</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
            <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="witch.containers.Parameter" class="doc doc-heading">
            <code>Parameter</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>Dataclass to represent a single parameter of a model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Parameter.name">name</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the parameter.
This is used only for display purposes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Parameter.fit">fit</span></code></td>
            <td>
                  <code>list[bool]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Should be a a list with length <code>Model.n_rounds</code>.
<code>fit[i]</code> is True if we want to fit this parameter in the <code>i</code>'th round.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Parameter.val">val</span></code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The value of the parameter.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Parameter.err">err</span></code></td>
            <td>
                  <code>float, default: 0</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The error on the parameter value.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Parameter.prior">prior</span></code></td>
            <td>
                  <code>Optional[tuple[float, float]], default: None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The prior on this parameter.
Set to None to have to prior,
otherwise should be the tuple <code>(lower_bound, upper_bound)</code>.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>witch/containers.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Parameter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataclass to represent a single parameter of a model.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the parameter.</span>
<span class="sd">        This is used only for display purposes.</span>
<span class="sd">    fit : list[bool]</span>
<span class="sd">        Should be a a list with length `Model.n_rounds`.</span>
<span class="sd">        `fit[i]` is True if we want to fit this parameter in the `i`&#39;th round.</span>
<span class="sd">    val : float</span>
<span class="sd">        The value of the parameter.</span>
<span class="sd">    err : float, default: 0</span>
<span class="sd">        The error on the parameter value.</span>
<span class="sd">    prior : Optional[tuple[float, float]], default: None</span>
<span class="sd">        The prior on this parameter.</span>
<span class="sd">        Set to None to have to prior,</span>
<span class="sd">        otherwise should be the tuple `(lower_bound, upper_bound)`.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">fit</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
    <span class="n">val</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">err</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">prior</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Only flat for now</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># If this isn&#39;t a float autograd breaks</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">fit_ever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if this parameter is set to ever be fit.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fit_ever : bool</span>
<span class="sd">            True if this parameter is ever fit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="witch.containers.Parameter.fit_ever" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">fit_ever</span><span class="p">:</span> <span class="nb">bool</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-property"><code>property</code></small>
  </span>

</h3>


    <div class="doc doc-contents ">

      <p>Check if this parameter is set to ever be fit.</p>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>fit_ever</code></td>            <td>
                  <code>bool</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if this parameter is ever fit.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>
    </div>

</div>





  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h2 id="witch.containers.Structure" class="doc doc-heading">
            <code>Structure</code>


  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-dataclass"><code>dataclass</code></small>
  </span>

</h2>


    <div class="doc doc-contents ">


      <p>Dataclass to represent a structure within the model.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Structure.name">name</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the structure.
This is used only for display purposes.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Structure.structure">structure</span></code></td>
            <td>
                  <code>str</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The type of structure that this is an instance of.
Should be a string that appears in <code>core.ORDER</code></p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="witch.containers.Structure.parameters">parameters</span></code></td>
            <td>
                  <code>list[<a class="autorefs autorefs-internal" title="witch.containers.Parameter" href="#witch.containers.Parameter">Parameter</a>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The model parameters for this structure.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>ValueError</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>structure</code> is not a valid structure.
If we have the wrong number of parameters.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

              <details class="quote">
                <summary>Source code in <code>witch/containers.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Structure</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Dataclass to represent a structure within the model.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the structure.</span>
<span class="sd">        This is used only for display purposes.</span>
<span class="sd">    structure : str</span>
<span class="sd">        The type of structure that this is an instance of.</span>
<span class="sd">        Should be a string that appears in `core.ORDER`</span>
<span class="sd">    parameters : list[Parameter]</span>
<span class="sd">        The model parameters for this structure.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        If `structure` is not a valid structure.</span>
<span class="sd">        If we have the wrong number of parameters.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">structure</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">parameters</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># Check that this is a valid structure</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">structure</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">STRUCT_N_PAR</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has invalid structure: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Check that we have the correct number of params</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STRUCT_N_PAR</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> has incorrect number of parameters, expected </span><span class="si">{</span><span class="n">STRUCT_N_PAR</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="p">]</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">structure</span><span class="si">}</span><span class="s2"> but was given </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">











  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="../../javascripts/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>